@page "/game/{username}/{lobbyname}"
@using Microsoft.AspNetCore.SignalR.Client
@using BlazorFrontEnd.Services
@using Asteroids.Shared.GameObjects
@inject RemoteAkkaService AkkaService
@inject SignalRService hubService

@* @inject HubConnection hubConnection *@
<h1>Welcome @Username</h1>


@if(@gameObject.state == GameState.JOINING){
    <div>Joining</div>
}else{
    <div>Playing</div>
}
<div>List of Joined</div>
@if(gameObject != null){
    @if(gameObject.ships != null){
        <div>Player Count: @gameObject.ships.Count</div>
        <ul>
        @foreach(var item in gameObject.ships)
        {
            <li> @item.Username</li>
        }
        </ul>
    }

}



@code {
    [Parameter]
    public string? Username {get;set;}

    [Parameter]
    public string? Lobbyname {get;set;}

    private List<string> list = new();

    private GameStateObject gameObject { get; set; }
    private System.Timers.Timer timer;

    protected override async Task OnInitializedAsync()
    {
        if(gameObject == null){
        gameObject = new();
        }
        await hubService.EnsureStartedAsync();
        hubService.NewGameState += ReceiveGameState;
        AkkaService.GetState(Lobbyname,Username);
        StartTimer();
    }

    public void Dispose()
    {
        hubService.NewGameState -= ReceiveGameState;
        timer.Stop();
    }


    private void ReceiveGameState(GameStateObject game){
        gameObject = game;
        Console.WriteLine(gameObject.state);
        if(gameObject == null){
            Console.WriteLine("null object gotten");
        }
        bool usernameFound = gameObject.ships.Any(ship => ship.Username == Username);
        
        if (!usernameFound)
        {
            Console.WriteLine($"Username '{Username}' not found in ships.");
        }
        InvokeAsync(StateHasChanged);
    }

    private void StartTimer()
    {
        timer = new System.Timers.Timer(100); // 1 millisecond interval
        timer.Elapsed += async (sender, e) =>
        {
            await InvokeAsync(async () =>
            {
                await AkkaService.GetState(Lobbyname,Username);
            });
        };
        timer.Start();
    }

}